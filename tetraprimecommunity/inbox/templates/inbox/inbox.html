{% extends "base.html" %}
{% load static %}
{% load preferences_filters %}

{% block title %}Your Messages & Alerts{% endblock %}
{% block body_class %}page-inbox-messages{% endblock %}

{% block content %}

{% include 'accounts/includes/header-tag.html' %}

<main class="container-fluid" xmlns="http://www.w3.org/1999/html">
    <div class="col">
        <div class="row">
            <div class="col-12 p-4 px-md-5 mt-3">
                <h1 class="text-center"><i class="bi bi-envelope-exclamation color-mediumseagreen"></i> Messages</h1>
            </div>
        </div>
        <div class="row">
            <div class="col col-md-5 px-4 ps-md-5 pe-md-3 py-4 d-flex flex-column">
                <h2 class="mb-4">My Inbox</h2>
                {% if not items %}
                <p><em>No active messages.</em></p>
                {% endif %}
                {% for item in items %}
                <div class="card mb-4">
                    {% if item.item_type == 'message' %}
                        <span class="position-absolute top-0 translate-middle-y badge rounded-pill bg-primary {% if item.has_unread %}bg-success{% endif %}" style="right: 10px;" title="Project Creator"><i class="bi bi-envelope-at-fill fs-6"></i>{% if item.has_unread %}<span class="ms-1">New</span>{% endif %}</span>
                    {% else %}
                        <span class="position-absolute top-0 translate-middle-y badge rounded-pill bg-warning" style="right: 10px;" title="Project Creator"><i class="bi bi-bell-fill fs-6"></i></span>
                    {% endif %}
                  <div class="row g-0">
                    {% if item.item_type == 'message' %}
                    <div class="col-3 order-1 p-2 pt-3">
                            <img
                                src="{% if item.other_user_profile_picture  %}{{ item.other_user_profile_picture }}{% else %}{% static 'custom/images/user-pfp-generic.png' %}{% endif %}"
                                alt="{{ item.other_user_username }}"
                                class="img-fluid w-100" style="border-radius: 2rem;"
                            >
                    </div>
                    {% else %}
                    {% endif %}
                    <div class="col {% if item.item_type == 'alert' %}col-12{% endif %}">
                      <div class="card-body">
                        <h3 class="card-title fs-6">
                            {% if item.item_type == 'message' %}
                                {% if item.subject %}
                                    {{ item.subject }} <br>from
                                {% endif %}
                                @{{ item.other_user_username }}
                            {% else %}
                                <!-- Alert -->
                                {{ item.title }}
                            {% endif %}
                        </h3>
                        {% if item.item_type == 'alert' %}<p class="card-text">{{ item.body|truncatewords:15 }}</p>{% endif %}
                        {% if item.item_type == 'message' %}<p class="card-text">"{{ item.latest_message_body|truncatewords:15 }}"</p>{% endif %}
                        <p class="card-text mb-3"><small class="text-body-secondary">
                            {% if item.latest_message_time %}
                            <!--Latest messsage timestamp-->
                            {{ item.latest_message_time|date:"m/d/y" }}<br>at {{ item.latest_message_time|date:"P" }}
                            {% else %}
                            <!--Alert sent timestamp-->
                            {{ item.sent_at|date:"m/d/y" }}<br>at {{ item.sent_at|date:"P" }}
                            {% endif %}
                        </small></p>
                        <p class="card-text"><small class="text-body-secondary">
                            {% if item.item_type == 'message' %}
                            <a href="{% url 'view_thread' item.id %}" class="btn btn-primary btn-sm"><i class="bi bi-eye"></i> Read</a>
                            {% comment %}{% endcomment %}
                            <a href="{% url 'delete_message_thread' item.id %}" class="btn btn-outline-secondary btn-sm" onclick="return confirm('Are you sure you want to delete this entire thread?');"><i class="bi bi-trash3"></i> Delete</a>
                            {% endif %}
                            {% if item.item_type == 'alert' %}
                            <a href="{% url 'delete_alert' item.id %}" class="btn btn-outline-secondary btn-sm" onclick="return confirm('Are you sure you want to delete this alert?');"><i class="bi bi-trash3"></i> Clear Alert</a>
                            {% endif %}
                        </small></p>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}

            </div>
            <!--<div class="col col-md-5 px-4 ps-md-5 pe-md-3 py-4 d-flex flex-column">-->
            <div class="col px-4 px-md-5 py-4 d-flex flex-column">
                <h2 class="mb-4 color-mediumseagreen">Write a message</h2>
                <p class="mb-5 w-75">Select an active message from your Inbox or write a new message to one of your connections.</p>

                <div class="accordion" id="accordionExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                <i class="bi bi-text-paragraph color-green me-1"></i> Write New Message
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                            <div class="accordion-body">

                                <form method="post" action="{% url 'send_message' %}">
                                    {% csrf_token %}
                                    <label for="receiver">To:</label>
                                    <input type="text" name="receiver_username" id="receiver" required class="form-control mb-3">
                                    <label for="body">Message:</label>
                                    <textarea name="body" id="body" required class="form-control mb-3"></textarea>
                                    <button type="submit" class="btn btn-primary btn-sm">Send Message</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% if user.is_staff %}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                <i class="bi bi-bell color-orange me-1"></i> Send An Alert <span class="fw-normal ms-2"><em>(Admin only)</em></span>
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <form method="post" action="{% url 'send_alert' %}">
                                    {% csrf_token %}
                                    <label for="receiver_username">Send to:</label>
                                    <input type="text" name="receiver_username" id="receiver_username" required class="form-control mb-3">
                                    <label for="title">Alert Title:</label>
                                    <input type="text" name="title" id="title" required class="form-control mb-3">
                                    <label for="body_alert">Alert Body:</label>
                                    <textarea name="body" id="body_alert" class="form-control mb-3"></textarea>
                                    <label for="alert_type">Alert Type:</label>
                                    <select name="alert_type" id="alert_type" class="form-control mb-3">
                                        <option value="info">Info</option>
                                        <option value="warning">Warning</option>
                                        <option value="success">Success</option>
                                    </select>
                                    <button type="submit" class="btn btn-warning btn-sm">Send Alert</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}